<div class="my-sessions-root p-3">
  <div class="header-card card mb-4 p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="mb-0">My Sessions</h3>
        <div class="small text-muted">{{ visibleSessions.length || 0 }} sessions</div>
      </div>
    </div>
    
    <div class="d-flex flex-wrap align-items-center gap-3">
      <div *ngIf="currentUser?.isTutor" class="view-buttons">
        <div class="btn-group" role="group" aria-label="view mode">
          <button class="btn btn-sm" [ngClass]="{'btn-outline-primary': sessionsView!=='student', 'btn-primary': sessionsView==='student'}" (click)="setSessionsView('student')">View as Student</button>
          <button class="btn btn-sm" [ngClass]="{'btn-outline-primary': sessionsView!=='tutor', 'btn-primary': sessionsView==='tutor'}" (click)="setSessionsView('tutor')">View as Tutor</button>
        </div>
      </div>
      <div class="btn-group" role="group" aria-label="session filters">
        <button class="btn btn-sm" [ngClass]="{'btn-outline-secondary': filter!=='all', 'btn-primary': filter==='all'}" (click)="setFilter('all')">All</button>
        <button class="btn btn-sm" [ngClass]="{'btn-outline-secondary': filter!=='upcoming', 'btn-primary': filter==='upcoming'}" (click)="setFilter('upcoming')">Upcoming</button>
        <button class="btn btn-sm" [ngClass]="{'btn-outline-secondary': filter!=='past', 'btn-primary': filter==='past'}" (click)="setFilter('past')">Past</button>
      </div>
    </div>
  </div>

  <div class="sessions-grid row g-3">
    <div class="col-12 col-md-6 col-lg-4" *ngFor="let s of visibleSessions">
      <div class="session-card card p-3 h-100">
        <div class="d-flex align-items-start gap-3 mb-3">
          <div class="avatar rounded-circle bg-primary text-white d-flex align-items-center justify-content-center">{{ getTutorInitials(s) }}</div>
          <div class="flex-grow-1">
            <div class="fw-semibold text-dark mb-1">{{ s.subject }}</div>
            <div class="small text-secondary mb-2">with <span class="fw-semibold">{{ sessionsView === 'tutor' ? (s.studentName || s.student?.fullName || (s.studentId? (s.studentId._id || s.studentId) : 'Student')) : (getTutorName(s)) }}</span></div>
            <div class="d-flex align-items-center justify-content-between">
              <div class="small text-secondary">{{ s.scheduledAt | date:'short' }}</div>
              <span class="badge status" [ngClass]="{
                'bg-warning text-dark': s.status === 'scheduled',
                'bg-success': s.status === 'completed',
                'bg-secondary': s.status === 'cancelled'
              }">{{ s.status }}</span>
            </div>
          </div>
        </div>

        <div class="session-details mb-3">
          <div class="small text-muted mb-2"><i class="bi bi-calendar-event me-1"></i> {{ s.scheduledAt | date:'fullDate' }}</div>
          <div class="small text-muted"><i class="bi bi-clock me-1"></i> {{ formatTime(s) }}</div>
        </div>

        <div class="session-actions mt-auto">
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-outline-primary btn-sm" (click)="viewDetails(s)">Details</button>
            <button class="btn btn-success btn-sm" *ngIf="(s.status === 'completed' || isSessionEnded(s)) && !currentUser?.isTutor && !s.hasFeedback" (click)="openFeedback(s)">Leave Feedback</button>
            <span *ngIf="(s.status === 'completed' || isSessionEnded(s)) && !currentUser?.isTutor && s.hasFeedback" class="badge bg-light text-dark">You already rated</span>
            
            <!-- Start (for tutors) or Join (for students) -->
            <button *ngIf="isTutorForSession(s) && canStartSession(s) && s.status === 'scheduled'" class="btn btn-primary btn-sm" (click)="startSession(s)">
              <span *ngIf="startingSessionId !== s._id">Start Session</span>
              <span *ngIf="startingSessionId === s._id" class="spinner-border spinner-border-sm"></span>
            </button>
            <button *ngIf="!isTutorForSession(s) && (s.status === 'in-progress' || s.meetingUrl) && !isSessionEnded(s)" class="btn btn-outline-success btn-sm" (click)="joinSession(s)">Join Session</button>
            <button *ngIf="(isTutorForSession(s) || !currentUser?.isTutor) && s.status === 'in-progress'" class="btn btn-sm btn-outline-secondary" (click)="markComplete(s)">Mark Complete</button>
            <span *ngIf="isSessionEnded(s)" class="badge bg-secondary">Session ended</span>
            <button *ngIf="!isTutorForSession(s) && isWaitingForTutor(s)" class="btn btn-outline-secondary btn-sm" disabled>Waiting for tutor</button>
            
            <!-- Allow students to edit or delete their upcoming scheduled sessions -->
            <button *ngIf="!isTutorForSession(s) && s.status === 'scheduled' && !isSessionEnded(s)" class="btn btn-outline-secondary btn-sm" (click)="openEdit(s)">Edit</button>
            <button *ngIf="!isTutorForSession(s) && s.status === 'scheduled' && !isSessionEnded(s)" class="btn btn-outline-danger btn-sm" (click)="deleteSession(s)">Delete</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty state when there are no sessions for the current filter -->
  <div class="empty-sessions text-center py-5" *ngIf="!visibleSessions || visibleSessions.length === 0">
    <div class="empty-card">
      <i class="bi bi-calendar-check" aria-hidden="true"></i>
      <h5 class="mt-3">No sessions found</h5>
      <div class="small text-muted">
        <span *ngIf="filter === 'past'">You have no past sessions</span>
        <span *ngIf="filter === 'upcoming'">You have no upcoming sessions</span>
        <span *ngIf="filter === 'all'">You have no sessions</span>
      </div>
    </div>
  </div>

  <!-- Feedback modal overlay (only for students) -->
  <div *ngIf="!currentUser?.isTutor">
    <div class="feedback-backdrop" *ngIf="feedbackSession" [ngClass]="feedbackClosing ? 'fade-exit-active' : 'fade-enter-active'">
      <div class="feedback-modal card p-4" [ngClass]="feedbackClosing ? 'scale-exit-active' : 'scale-enter-active'">
        <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="fw-semibold">Leave Feedback for {{ getTutorName(feedbackSession) }}</div>
          <button class="btn-close" (click)="$event.stopPropagation(); feedbackSession = null"></button>
        </div>

        <div class="mb-3">
          <label class="form-label small">Rating</label>
            <div class="star-rating">
              <button type="button" class="star" *ngFor="let s of [1,2,3,4,5]" [class.selected]="feedbackRating >= s" (click)="feedbackRating = s">★</button>
            </div>
        </div>

        <div class="mb-3">
          <label class="form-label small">Comment</label>
          <textarea class="form-control" rows="3" [(ngModel)]="feedbackComment" placeholder="Comment (optional)"></textarea>
        </div>

        <div class="d-flex gap-2 justify-content-end">
          <button class="btn btn-outline-secondary" (click)="$event.stopPropagation(); feedbackSession = null" [disabled]="submittingFeedback">Cancel</button>
          <button class="btn btn-primary" (click)="$event.stopPropagation(); submitFeedback()" [disabled]="submittingFeedback">
            <span *ngIf="!submittingFeedback">Submit</span>
            <span *ngIf="submittingFeedback" class="spinner-border spinner-border-sm"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit session modal -->
  <div class="feedback-backdrop" *ngIf="editingSession">
    <div class="feedback-modal card p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="fw-semibold">Edit Session</div>
        <button class="btn-close" (click)="cancelEdit()"></button>
      </div>

      <div class="mb-2">
        <label class="form-label small">Subject</label>
        <input class="form-control" [(ngModel)]="editSubject" />
      </div>

      <div class="mb-2">
        <label class="form-label small">Choose an available slot (preferred)</label>
        <div *ngIf="hasEditingSlots()">
          <div *ngFor="let s of editingSlotOptionsSafe()" class="card p-2 mb-2 d-flex align-items-center">
            <input type="radio" name="editSlot" [value]="s._id" [(ngModel)]="selectedEditSlot" [ngModelOptions]="{standalone:true}" />
            <div class="ms-2">{{ s.startAt | date:'mediumDate' }} · {{ s.startAt | date:'shortTime' }} - {{ s.endAt | date:'shortTime' }} ({{ s.durationMinutes }}m)</div>
          </div>
        </div>
  <div *ngIf="!hasEditingSlots()" class="text-muted">No pre-created slots available — fallback to manual date/time</div>
      </div>

      <!-- Only allow moving session to an available pre-created slot. Hide manual date/time editing. -->
      <div *ngIf="!selectedEditSlot" class="text-muted">
        Select one of the tutor's available slots above to move this session. Manual edit of date/time is not supported.
      </div>
      <div class="mb-2">
        <label class="form-label small">Notes</label>
        <textarea class="form-control" rows="3" [(ngModel)]="editNotes"></textarea>
      </div>

      <div class="d-flex gap-2 justify-content-end">
        <button class="btn btn-outline-secondary" (click)="cancelEdit()">Cancel</button>
        <button class="btn btn-primary" (click)="saveEdit()">Save</button>
      </div>
    </div>
  </div>

  <!-- Jitsi modal -->
  <app-jitsi-modal [meetingUrl]="jitsiUrl" [visible]="jitsiVisible" [sessionId]="jitsiSessionId" [joinToken]="jitsiJoinToken" (close)="closeJitsi()"></app-jitsi-modal>

  <!-- Session details overlay -->
  <div class="details-backdrop" *ngIf="selectedSession">
    <div class="details-card card p-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <div class="fw-semibold">{{ selectedSession.subject }}</div>
          <div class="small text-muted">with {{ sessionsView === 'tutor' ? (selectedSession.studentName || selectedSession.student?.fullName || (selectedSession.studentId? (selectedSession.studentId._id || selectedSession.studentId) : 'Student')) : (getTutorName(selectedSession)) }}</div>
        </div>
        <button class="btn-close" (click)="selectedSession = null"></button>
      </div>

      <div class="mb-2 small text-secondary">Scheduled: {{ selectedSession.scheduledAt | date:'fullDate' }} at {{ selectedSession.scheduledAt | date:'shortTime' }}</div>
      <div class="mb-3 small text-secondary">Duration: {{ selectedSession.durationMinutes || selectedSession.duration || 'n/a' }} min</div>

      <div class="d-flex gap-2 justify-content-end">
            <button class="btn btn-outline-secondary" (click)="$event.stopPropagation(); selectedSession = null">Close</button>
        <button *ngIf="isTutorForSession(selectedSession) && canStartSession(selectedSession)" class="btn btn-primary" (click)="$event.stopPropagation(); startSession(selectedSession); selectedSession = null">Start Session</button>
      <button *ngIf="!isTutorForSession(selectedSession) && (selectedSession.status === 'in-progress' || selectedSession.meetingUrl) && !isSessionEnded(selectedSession)" class="btn btn-success" (click)="$event.stopPropagation(); joinSession(selectedSession); selectedSession = null">Join Session</button>
      <button *ngIf="!currentUser?.isTutor && (selectedSession.status === 'completed' || isSessionEnded(selectedSession))" class="btn btn-success" (click)="$event.stopPropagation(); openFeedback(selectedSession); selectedSession = null">Leave Feedback</button>
  <span *ngIf="isSessionEnded(selectedSession) && !(selectedSession.status === 'completed')" class="badge bg-secondary">Session ended</span>
        <button *ngIf="selectedSession.meetingUrl" class="btn btn-outline-primary" (click)="openExternal(selectedSession.meetingUrl)">Open in new tab</button>
      </div>

      <div *ngIf="selectedSession.meetingUrl" class="mt-3 p-2 border rounded bg-light">
        <div class="small text-muted">Meeting link</div>
        <div class="d-flex align-items-center gap-2">
          <div class="flex-grow-1 text-break">{{ selectedSession.meetingUrl }}</div>
          <button class="btn btn-sm btn-outline-secondary" (click)="copyMeetingLink(selectedSession.meetingUrl)">Copy</button>
        </div>
        <div class="small text-muted mt-2">Token: <span class="fw-semibold">{{ selectedSession.joinToken || '-' }}</span></div>
        <div class="small text-muted">Expires: <span class="fw-semibold">{{ selectedSession.meetingUrlExpiresAt ? (selectedSession.meetingUrlExpiresAt | date:'short') : '—' }}</span></div>
      </div>
    </div>
  </div>

</div>
